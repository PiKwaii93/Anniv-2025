<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tournament BeerPong</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
        }
        .reveal { animation: fadeIn 0.35s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Styles du Bracket (Arbre de tournoi) --- */

        /* Style des lignes de l'arbre de tournoi */
        .bracket-match {
            position: relative;
        }

        /* Ligne horizontale sortant du match */
        .bracket-match::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            height: 2px;
            /* Raccourci sur mobile, plus long sur desktop */
            width: 1.5rem; 
            @media (min-width: 768px) {
                width: 2rem; 
            }
            background-color: #4b5563; /* slate-600 */
            transform: translateY(-50%);
            z-index: 5;
        }

        /* Ligne verticale entre les matchs */
        .bracket-round > div:not(:last-child) > .bracket-match::before {
            content: '';
            position: absolute;
            top: 50%;
            left: calc(100% + 1.5rem); /* Positionne apr√®s la ligne horizontale mobile */
            @media (min-width: 768px) {
                left: calc(100% + 2rem); /* Positionne apr√®s la ligne horizontale desktop */
            }
            width: 2px;
            background-color: #4b5563; /* slate-600 */
            transform: translateY(-50%);
            z-index: 4;
        }

        /* Ajustement de la hauteur de la ligne verticale */
        .bracket-round > div:nth-child(odd) > .bracket-match::before {
            height: 100%;
            top: 0;
            border-top-right-radius: 4px;
        }
        .bracket-round > div:nth-child(even) > .bracket-match::before {
            height: 100%;
            top: auto;
            bottom: 0;
            border-bottom-right-radius: 4px;
        }

        /* Cache la ligne horizontale finale pour le gagnant qui passe au tour suivant */
        .bracket-round:last-child .bracket-match::after {
            display: none;
        }

        /* Ajoute une petite queue au gagnant du match pour se connecter √† la ligne verticale */
        .bracket-round > div:not(:last-child) > .bracket-match.match-win::after {
             background-color: #4b5563;
        }
    </style>
</head>
<body class="text-white min-h-screen p-4 md:p-8 flex flex-col items-center">

    <!-- Confirmation Modal Structure (Hidden by default) -->
    <div id="confirmationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 reveal">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-pink-500">
            <p id="confirmMessage" class="text-lg font-semibold mb-6 text-center text-white"></p>
            <div class="flex justify-around space-x-4">
                <button id="confirmCancel" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Annuler</button>
                <button id="confirmAccept" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Confirmer</button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl w-full">
        
        <header class="text-center mb-8 mt-4">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-600">
                üçª Tournoi BeerPong üçª
            </h1>
            <p class="mt-2 text-md md:text-xl text-slate-400 font-medium">
                G√©rez les √©quipes et suivez l'arbre de tournoi.
            </p>
        </header>

        <!-- Section Inscription des √âquipes -->
        <section class="bg-slate-800 p-6 rounded-2xl shadow-xl mb-8 border border-slate-700">
            <h2 class="text-2xl font-bold mb-4 text-pink-400">1. √âquipes Participantes</h2>
            <p class="text-sm text-slate-400 mb-4">Entrez les noms d'√©quipes s√©par√©s par des virgules ou des retours √† la ligne (2 √©quipes minimum). L'arbre g√©n√©r√© g√©rera automatiquement les "byes" (passer au tour suivant) si le nombre d'√©quipes n'est pas une puissance de 2.</p>
            
            <div class="flex flex-col md:flex-row gap-4">
                <textarea id="teamInput" 
                          rows="4"
                          placeholder="Ex: Team A, Les Vainqueurs, Les Zinzins, ..."
                          class="flex-grow bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-pink-500 focus:ring focus:ring-pink-500 focus:ring-opacity-50 resize-none"></textarea>
                
                <div class="flex flex-col space-y-3">
                    <button id="addTeamsBtn" 
                            class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition duration-150 transform hover:scale-105">
                        Ajouter / Mettre √† jour
                    </button>
                    <!-- Le bouton de g√©n√©ration est activ√© d√®s qu'il y a 2 √©quipes ou plus -->
                    <button id="generateBtn" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition duration-150 transform hover:scale-105">
                        G√©n√©rer l'Arbre !
                    </button>
                </div>
            </div>

            <!-- Liste des √©quipes inscrites -->
            <div id="teamListContainer" class="mt-6 reveal">
                <h3 class="text-lg font-semibold text-slate-300 mb-2">Liste actuelle (<span id="teamCount">0</span> √©quipes) :</h3>
                <div id="teamList" class="flex flex-wrap gap-2 text-sm">
                    <!-- Les badges d'√©quipe seront ins√©r√©s ici -->
                </div>
            </div>
        </section>

        <!-- Section Arbre de Tournoi -->
        <section id="bracketArea" class="hidden bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl mb-8 border border-slate-700 reveal overflow-x-auto">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-4">
                <h2 class="text-2xl font-bold text-pink-400">2. Arbre du Tournoi</h2>
                <div class="flex flex-wrap justify-end gap-3">
                    <button id="downloadBtn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-150">
                        T√©l√©charger l'√©tat
                    </button>
                    <button id="resetBtn" 
                            class="bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-150">
                        R√©initialiser
                    </button>
                </div>
            </div>

            <!-- Badge Champion -->
            <div id="championBadge" class="hidden text-center mb-6 reveal">
                <p class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-600">
                    üèÜ CHAMPION : <span id="championName" class="text-yellow-300"></span> üèÜ
                </p>
            </div>

            <!-- Conteneur du Bracket -->
            <div id="bracketContainer" class="flex md:gap-12 gap-6 items-start">
                <!-- Les tours seront inject√©s ici -->
            </div>
        </section>
        
    </main>

    <footer class="mt-8 text-center pb-12 w-full flex flex-col items-center">
        <!-- Message personnalis√© original -->
        <p class="text-md text-pink-400 font-medium mb-6">
            G√©r√© par le meilleur des outils de soir√©e !
        </p>

        <!-- Bouton de retour -->
        <a href="index.html" class="px-8 py-3 bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-full transition duration-300 shadow-lg shadow-pink-500/50">
            <span class="mr-2">üè†</span> Retour √† l'Accueil des Jeux
        </a>
    </footer>

    <script>
        // Utilisation de localStorage pour la persistance de l'√©tat
        const LOCAL_KEY = 'beerpongTournamentState';

        // Variables d'√©tat
        let teams = [];
        let rounds = null;
        let confirmCallback = null;
        
        // R√©f√©rences DOM
        const teamInput = document.getElementById('teamInput');
        const teamList = document.getElementById('teamList');
        const teamCountSpan = document.getElementById('teamCount');
        const addTeamsBtn = document.getElementById('addTeamsBtn');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const bracketArea = document.getElementById('bracketArea');
        const bracketContainer = document.getElementById('bracketContainer');
        const championBadge = document.getElementById('championBadge');
        const championNameSpan = document.getElementById('championName');
        const teamListContainer = document.getElementById('teamListContainer'); // Ajout de cette r√©f√©rence

        // R√©f√©rences Modal
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmAccept = document.getElementById('confirmAccept');


        // --- Fonctions d'Utilit√© et d'√âtat ---

        // Affiche la modale de confirmation
        function showConfirm(message, callback) {
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        // Cache la modale de confirmation
        function hideConfirm() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // Sauvegarde l'√©tat du tournoi dans localStorage
        function saveState() {
            localStorage.setItem(LOCAL_KEY, JSON.stringify({ teams, rounds }));
        }

        // Charge l'√©tat du tournoi depuis localStorage
        function loadState() {
            const savedState = localStorage.getItem(LOCAL_KEY);
            if (savedState) {
                const state = JSON.parse(savedState);
                teams = state.teams || [];
                rounds = state.rounds || null;
                // Remplir la zone de texte pour affichage
                teamInput.value = teams.map(t => t.name).join(', ');
            }
        }

        // Met √† jour l'affichage de la liste des √©quipes
        function updateTeamsUI() {
            teamList.innerHTML = '';
            teamCountSpan.textContent = teams.length;
            teams.forEach(team => {
                const badge = document.createElement('span');
                badge.className = 'bg-pink-500 text-white px-3 py-1 rounded-full text-xs font-semibold';
                badge.textContent = team.name;
                teamList.appendChild(badge);
            });

            // Active le bouton 'G√©n√©rer' si au moins 2 √©quipes sont pr√©sentes
            const isReadyToGenerate = teams.length >= 2;
            generateBtn.disabled = !isReadyToGenerate;
            generateBtn.classList.toggle('opacity-50', !isReadyToGenerate);
            
            // Suppression de l'ancienne logique d'avertissement de puissance de 2
            const existingWarning = teamListContainer.querySelector('.text-red-400');
            if (existingWarning) existingWarning.remove();
        }

        // M√©lange les √©quipes et cr√©e le premier tour (gestion des byes)
        function generateBracket() {
            if (teams.length < 2) {
                console.error("Minimum 2 √©quipes requises pour g√©n√©rer l'arbre.");
                return;
            }

            // 1. D√©terminer la prochaine puissance de 2
            let numTeams = teams.length;
            let nextPowerOfTwo = 2;
            while (nextPowerOfTwo < numTeams) {
                nextPowerOfTwo *= 2;
            }

            // 2. Cr√©er la liste des participants incluant les "byes" (null)
            const shuffledTeams = [...teams].sort(() => 0.5 - Math.random());
            const totalMatches = nextPowerOfTwo / 2;
            
            // Ajouter des 'null' (bye) si n√©cessaire pour arriver √† nextPowerOfTwo participants
            let participants = [...shuffledTeams];
            for (let i = 0; i < nextPowerOfTwo - numTeams; i++) {
                participants.push(null); 
            }
            
            // Re-m√©langer avec les byes pour distribuer √©quitablement
            // Cependant, la m√©thode d'insertion des byes doit √™tre strat√©gique, pour l'instant on se contente de les mettre √† la fin.
            
            // 3. Cr√©er le premier tour
            let currentRound = [];
            for (let i = 0; i < participants.length; i += 2) {
                const team1 = participants[i];
                const team2 = participants[i + 1];

                const match = {
                    id: Math.random().toString(36).substring(2, 9),
                    team1: team1 ? team1 : { name: 'BYE' }, // Utiliser BYE pour les nulls pour le rendu
                    team2: team2 ? team2 : { name: 'BYE' },
                    winner: null
                };

                // Si c'est un BYE contre une √©quipe r√©elle, l'√©quipe r√©elle gagne automatiquement
                if (team1 && team1.name !== 'BYE' && (!team2 || team2.name === 'BYE')) { // team1 vs BYE
                    match.winner = team1;
                } else if (team2 && team2.name !== 'BYE' && (!team1 || team1.name === 'BYE')) { // BYE vs team2
                    match.winner = team2;
                } else if ((!team1 || team1.name === 'BYE') && (!team2 || team2.name === 'BYE')) { 
                    // Double BYE (ne devrait pas arriver avec notre logique)
                    match.winner = { name: '√Ä d√©terminer' }; 
                }
                
                currentRound.push(match);
            }
            
            // 4. Propager les gagnants des byes (si le gagnant est d√©j√† d√©fini)
            rounds = [currentRound];
            
            let numRounds = Math.log2(nextPowerOfTwo);
            
            // Cr√©er les tours suivants vides
            for (let i = 1; i < numRounds; i++) {
                let nextRound = [];
                const prevRound = rounds[i - 1];
                for (let j = 0; j < prevRound.length / 2; j++) {
                    const matchIndex1 = j * 2;
                    const matchIndex2 = j * 2 + 1;

                    // Les √©quipes sont initialis√©es au gagnant du match pr√©c√©dent
                    const team1 = prevRound[matchIndex1].winner;
                    const team2 = prevRound[matchIndex2].winner;
                    
                    nextRound.push({
                         id: Math.random().toString(36).substring(2, 9),
                         team1: team1, 
                         team2: team2, 
                         winner: null
                    });
                }
                rounds.push(nextRound);
            }
            
            // 5. Mise √† jour de tous les tours (important pour les byes)
            // On s'assure que les byes sont propag√©s correctement
            for(let i = 0; i < rounds.length; i++) {
                rounds[i].forEach((match, j) => {
                    // Si le match a un gagnant fixe (comme un BYE) ou d√©j√† s√©lectionn√©, on propage
                    if (match.winner) {
                        updateNextRounds(i, j);
                    }
                });
            }


            saveState();
            bracketArea.classList.remove('hidden');
            renderBracket();
        }
        
        // Met √† jour le gagnant d'un match
        function setWinner(roundIndex, matchIndex, team) {
            // Un BYE ne peut pas √™tre s√©lectionn√© comme gagnant (ni d√©s√©lectionn√©)
            if (team && team.name === 'BYE') return;

            // R√©cup√©rer le match en cours
            const match = rounds[roundIndex][matchIndex];
            
            // V√©rifier si le clic est sur un match dont le gagnant est fix√© (match BYE)
            const isByeMatch = (match.team1 && match.team1.name === 'BYE') || (match.team2 && match.team2.name === 'BYE');
            if (isByeMatch) {
                // Si c'est un match avec BYE, le gagnant est fix√© (l'√©quipe non-BYE). Ne pas permettre le changement.
                return;
            }
            
            // Logique de s√©lection/d√©s√©lection normale
            if (match.winner && match.winner.name === team.name) {
                // Si on clique sur le gagnant, le d√©s√©lectionner
                match.winner = null;
            } else {
                match.winner = team;
            }

            // Mettre √† jour les tours suivants
            updateNextRounds(roundIndex, matchIndex);

            saveState();
            renderBracket();
        }

        // Propage le gagnant au tour suivant
        function updateNextRounds(roundIndex, matchIndex) {
            const winner = rounds[roundIndex][matchIndex].winner;
            const nextRoundIndex = roundIndex + 1;
            
            if (nextRoundIndex < rounds.length) {
                const nextMatchIndex = Math.floor(matchIndex / 2);
                const isFirstTeam = matchIndex % 2 === 0;
                
                // Mettre √† jour l'√©quipe dans le match suivant
                if (isFirstTeam) {
                    rounds[nextRoundIndex][nextMatchIndex].team1 = winner;
                } else {
                    rounds[nextRoundIndex][nextMatchIndex].team2 = winner;
                }
                
                // Si le gagnant est retir√©, le match suivant est r√©initialis√© et la propagation continue (r√©cursivit√©)
                if (winner === null) {
                    rounds[nextRoundIndex][nextMatchIndex].winner = null;
                    updateNextRounds(nextRoundIndex, nextMatchIndex);
                } else {
                    // Si le nouveau match du tour suivant est devenu un BYE (ex: Team vs null/√Ä d√©terminer)
                    const nextMatch = rounds[nextRoundIndex][nextMatchIndex];
                    const t1Known = nextMatch.team1 && nextMatch.team1.name !== '√Ä d√©terminer' && nextMatch.team1.name !== 'BYE';
                    const t2Known = nextMatch.team2 && nextMatch.team2.name !== '√Ä d√©terminer' && nextMatch.team2.name !== 'BYE';

                    if (t1Known && (!nextMatch.team2 || nextMatch.team2.name === '√Ä d√©terminer' || nextMatch.team2.name === 'BYE')) {
                        // Match de type BYE dans les tours interm√©diaires (apr√®s que l'√©quipe 2 ait √©t√© retir√©e)
                        nextMatch.winner = nextMatch.team1;
                        updateNextRounds(nextRoundIndex, nextMatchIndex);
                    } else if (t2Known && (!nextMatch.team1 || nextMatch.team1.name === '√Ä d√©terminer' || nextMatch.team1.name === 'BYE')) {
                         // Match de type BYE dans les tours interm√©diaires (apr√®s que l'√©quipe 1 ait √©t√© retir√©e)
                        nextMatch.winner = nextMatch.team2;
                        updateNextRounds(nextRoundIndex, nextMatchIndex);
                    } else if (nextMatch.winner !== null) {
                        // Si les deux √©quipes sont √† nouveau connues, on retire le gagnant pour que l'utilisateur puisse choisir √† nouveau
                        nextMatch.winner = null;
                        updateNextRounds(nextRoundIndex, nextMatchIndex);
                    }
                }
            }
        }


        // --- Fonctions de Rendu (UI) ---

        // Cr√©e l'√©l√©ment DOM pour un match
        function createMatchElement(match, roundIndex, matchIndex) {
            const matchDiv = document.createElement('div');
            // La classe match-win sert √† styler la ligne de connexion
            const isWinnerSelected = match.winner && match.winner.name !== '√Ä d√©terminer';
            matchDiv.className = `bracket-match relative mb-8 w-36 md:w-48 ${isWinnerSelected ? 'match-win' : ''}`;

            const team1 = match.team1;
            const team2 = match.team2;

            if (team1) {
                matchDiv.appendChild(createTeamElement(team1, match.winner, 1, roundIndex, matchIndex));
            } else {
                matchDiv.appendChild(createPlaceholderTeam(1)); 
            }

            if (team2) {
                matchDiv.appendChild(createTeamElement(team2, match.winner, 2, roundIndex, matchIndex));
            } else {
                matchDiv.appendChild(createPlaceholderTeam(2));
            }
            
            return matchDiv;
        }

        // Cr√©e l'√©l√©ment DOM pour une √©quipe
        function createTeamElement(team, winner, teamNumber, roundIndex, matchIndex) {
            const teamDiv = document.createElement('div');
            const isWinner = winner && winner.name === team.name;
            const isBye = team.name === 'BYE';
            const isFuture = team.name === '√Ä d√©terminer';
            
            // Un match BYE est un match o√π l'un des participants est 'BYE'. Son gagnant est fix√©.
            const match = rounds[roundIndex][matchIndex];
            const isFixedByeMatch = (match.team1 && match.team1.name === 'BYE') || (match.team2 && match.team2.name === 'BYE');
            
            let baseClasses = 'p-2 my-0.5 rounded-lg text-sm truncate transition duration-150 ease-in-out select-none';
            
            if (isBye || isFuture) {
                // Style pour le BYE ou l'√©quipe Future
                teamDiv.className = `${baseClasses} bg-slate-800 text-slate-500 italic border border-slate-700 pointer-events-none`;
                teamDiv.textContent = isBye ? 'BYE' : '√Ä d√©terminer';
            } else if (isFixedByeMatch) {
                // L'√©quipe qui gagne par BYE est affich√©e comme gagnante mais n'est pas cliquable
                teamDiv.className = `${baseClasses} bg-pink-600 font-bold shadow-lg text-slate-100 border border-pink-500 pointer-events-none`;
                teamDiv.textContent = team.name;
            } else if (isWinner) {
                // Style pour le Vainqueur s√©lectionn√© par l'utilisateur
                teamDiv.className = `${baseClasses} bg-pink-600 font-bold shadow-lg transform scale-105 cursor-pointer text-slate-100 border border-pink-500 hover:bg-pink-700`;
                teamDiv.textContent = team.name;
                teamDiv.addEventListener('click', () => {
                     setWinner(roundIndex, matchIndex, team);
                 });
            } else {
                // Style par d√©faut (√©quipe en attente)
                teamDiv.className = `${baseClasses} bg-slate-700 hover:bg-slate-600 border border-slate-600 cursor-pointer text-slate-100`;
                teamDiv.textContent = team.name;
                teamDiv.addEventListener('click', () => {
                     setWinner(roundIndex, matchIndex, team);
                 });
            }

            return teamDiv;
        }

        // Cr√©e l'√©l√©ment DOM pour une √©quipe dont le nom n'est pas encore connu
        function createPlaceholderTeam(teamNumber) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'p-2 my-0.5 rounded-lg text-sm italic text-slate-500 bg-slate-800 border border-slate-700 pointer-events-none select-none';
            teamDiv.textContent = `Gagnant Match Pr√©c√©dent`; 
            return teamDiv;
        }

        // Cr√©e l'√©l√©ment DOM pour un tour complet
        function createRoundElement(round, roundIndex) {
            const roundDiv = document.createElement('div');
            // Ajustement de la hauteur du conteneur en fonction du nombre de matchs
            const matchCount = round.length;
            const roundHeightClass = matchCount > 1 ? 'justify-around' : 'justify-center'; 

            roundDiv.className = `bracket-round flex flex-col ${roundHeightClass} h-full`; 
            
            // Ajout d'un padding top important pour la finale
            if (roundIndex === rounds.length - 1) {
                roundDiv.classList.add('pt-16');
            }

            round.forEach((match, matchIndex) => {
                roundDiv.appendChild(createMatchElement(match, roundIndex, matchIndex));
            });

            return roundDiv;
        }

        // Fonction principale de rendu de l'arbre
        function renderBracket() {
            bracketContainer.innerHTML = '';
            championBadge.classList.add('hidden');
            championNameSpan.textContent = '';
            
            if (!rounds || rounds.length === 0) return;

            // Rendu de tous les tours
            rounds.forEach((round, roundIndex) => {
                bracketContainer.appendChild(createRoundElement(round, roundIndex));
            });
            
            // V√©rification et affichage du Champion
            const finalRound = rounds[rounds.length - 1];
            if (finalRound && finalRound.length > 0 && finalRound[0].winner) {
                const champion = finalRound[0].winner;
                 if (champion && champion.name !== '√Ä d√©terminer' && champion.name !== 'BYE') {
                    championNameSpan.textContent = champion.name;
                    championBadge.classList.remove('hidden');
                 }
            }
        }


        // --- Gestion des √âv√©nements ---

        confirmCancel.addEventListener('click', hideConfirm);
        confirmAccept.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirm();
        });


        addTeamsBtn.addEventListener('click', () => {
            const rawText = teamInput.value.trim();
            if (!rawText) return;

            // Nettoyer et s√©parer les noms (par virgule ou saut de ligne)
            const teamNames = rawText.split(/[\n,]+/)
                                     .map(name => name.trim())
                                     .filter(name => name.length > 0);

            // Mettre √† jour la liste des √©quipes
            teams = teamNames.map(name => ({ name }));
            
            updateTeamsUI();
            saveState();
        });

        generateBtn.addEventListener('click', () => {
             // La v√©rification est maintenant effectu√©e dans generateBracket et est moins restrictive
             if (teams.length >= 2) {
                 generateBracket();
             } else {
                 showConfirm("Veuillez ajouter au moins deux √©quipes pour g√©n√©rer l'arbre.", () => {});
             }
        });

        resetBtn.addEventListener('click', () => {
            showConfirm('R√©initialiser tout le tournoi ?', () => {
                teams = [];
                rounds = null;
                localStorage.removeItem(LOCAL_KEY);
                updateTeamsUI();
                renderBracket();
                bracketArea.classList.add('hidden');
                championBadge.classList.add('hidden');
                teamInput.value = ''; // Vider le champ
            });
        });

        downloadBtn.addEventListener('click', () => {
            const state = { teams, rounds };
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'beerpong_tournament.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // --- Init --
        window.addEventListener('load', () => {
            loadState();
            updateTeamsUI();
            if (rounds) {
                bracketArea.classList.remove('hidden'); 
                renderBracket();
            }
        });
    </script>
</body>
</html>
